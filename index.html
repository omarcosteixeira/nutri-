<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora NUTRI+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para exportação de imagem e PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        /* Cores da paleta personalizada */
        .bg-primary { background-color: #053545; }
        .bg-secondary { background-color: #153828; }
        .text-primary { color: #053545; }
        .text-secondary { color: #153828; }
        .border-primary { border-color: #053545; }
        
        /* Estilos para impressão */
        @media print {
            body * {
                visibility: hidden;
            }
            #printable-area, #printable-area * {
                visibility: visible;
            }
            #printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
        .result-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        .icon-placeholder {
            width: 24px;
            height: 24px;
        }
        /* Notificação customizada */
        #notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #notification.show {
            opacity: 1;
            visibility: visible;
        }
        textarea {
            resize: vertical;
        }
        #figure-image {
            max-width: 100%;
            max-height: 384px; /* h-96 */
            object-fit: contain;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Cabeçalho -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-primary">Calculadora NUTRI+</h1>
            <p class="text-gray-600 mt-2">Avaliação nutricional completa e simplificada.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Coluna de Inserção de Dados -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-secondary mb-6 border-b pb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        Informações do Paciente
                    </h2>
                    <form id="patient-form" class="space-y-4">
                        <input type="hidden" id="patient-id">
                        <input type="text" id="nome" placeholder="Nome completo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent">
                        
                        <div class="grid grid-cols-2 gap-4">
                            <select id="sexo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent">
                                <option value="masculino">Masculino</option>
                                <option value="feminino">Feminino</option>
                            </select>
                            <input type="number" id="idade" placeholder="Idade (anos)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" step="0.01" id="peso" placeholder="Peso (kg)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent">
                            <input type="number" step="0.01" id="altura" placeholder="Altura (m)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent">
                        </div>
                        
                        <input type="number" id="circunferencia_abdominal" placeholder="Circ. Abdominal (cm)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent">
                        
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="dct" placeholder="DCT (mm)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent" title="Dobra Cutânea do Tríceps">
                            <input type="number" id="dcb" placeholder="DCB (mm)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent" title="Dobra Cutânea do Bíceps">
                        </div>

                        <input type="number" id="perimetro_braco" placeholder="Perímetro Braço (cm)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent">

                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Objetivo (VET):</label>
                            <select id="vet-goal" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent">
                                <option value="manter">Manter Peso</option>
                                <option value="perder">Perder Peso</option>
                                <option value="ganhar">Ganhar Peso</option>
                            </select>
                        </div>

                        <button type="button" id="calculate-btn" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-opacity-90 transition-colors">
                            Calcular e Gerar Relatório
                        </button>
                        <button type="button" id="save-patient-btn" class="w-full bg-secondary text-white font-bold py-3 px-4 rounded-lg hover:bg-opacity-90 transition-colors mt-2">
                            Salvar Paciente
                        </button>
                    </form>
                </div>
                
                <!-- Gerenciamento de Pacientes -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-secondary mb-6 border-b pb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Gerenciar Pacientes
                    </h2>
                    <div class="space-y-4">
                        <select id="patient-list" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent">
                            <option value="">Selecione um paciente</option>
                        </select>
                        <div class="grid grid-cols-2 gap-4">
                            <button type="button" id="load-patient-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors">Carregar</button>
                            <button type="button" id="delete-patient-btn" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition-colors">Deletar</button>
                        </div>
                         <button type="button" id="new-patient-btn" class="w-full border-2 border-primary text-primary font-bold py-3 px-4 rounded-lg hover:bg-primary hover:text-white transition-colors mt-2">
                            Novo Paciente
                        </button>
                    </div>
                </div>
            </div>

            <!-- Coluna de Resultados -->
            <div id="results-container" class="lg:col-span-2 hidden">
                <div id="printable-area">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-start">
                             <div>
                                <h2 class="text-2xl font-semibold text-secondary mb-4">Relatório Nutricional</h2>
                                <p class="text-lg font-medium text-primary mb-6" id="report-name">Paciente: </p>
                             </div>
                             <h1 class="text-2xl font-bold text-primary">NUTRI+</h1>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Cards de resultado (IMC, Risco, etc.) -->
                            <div class="result-card border-l-4 border-orange-400">
                                <h3 class="font-semibold text-gray-800 flex items-center mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 icon-placeholder"><path d="M12 14v8"/><path d="M12 4v2"/><path d="m4.9 6.3 1.4 1.4"/><path d="m17.7 7.7 1.4-1.4"/><path d="M4 12H2"/><path d="M22 12h-2"/><path d="m4.9 17.7 1.4-1.4"/><path d="m17.7 16.3 1.4 1.4"/><circle cx="12" cy="12" r="4"/></svg>
                                    IMC
                                </h3>
                                <p class="text-3xl font-bold text-primary" id="imc-value">-</p>
                                <p class="font-medium text-gray-600" id="imc-class">-</p>
                                <p class="text-sm text-gray-500 mt-2">Peso Ideal: <span id="ideal-weight">-</span></p>
                            </div>
                            
                            <!-- Card de Percentil (Apenas para Crianças/Adolescentes) -->
                            <div id="percentile-card" class="result-card border-l-4 border-teal-400 hidden">
                                <h3 class="font-semibold text-gray-800 flex items-center mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 icon-placeholder"><path d="M3 3v18h18"/><path d="M7 14l5-5 4 4 5-5"/></svg>
                                    Percentil IMC (OMS)
                                </h3>
                                <p class="text-3xl font-bold text-primary" id="percentile-value">-</p>
                                <p class="font-medium text-gray-600" id="percentile-class">-</p>
                            </div>

                            <div class="result-card border-l-4 border-red-400">
                                <h3 class="font-semibold text-gray-800 flex items-center mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 icon-placeholder"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                                    Risco (Circ. Abd.)
                                </h3>
                                <p class="text-3xl font-bold text-primary" id="rcq-value">- cm</p>
                                <p class="font-medium text-gray-600" id="rcq-class">-</p>
                            </div>

                            <div class="result-card border-l-4 border-yellow-400">
                                <h3 class="font-semibold text-gray-800 flex items-center mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 icon-placeholder"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 12c-4.418 0-8-1.79-8-4s3.582-4 8-4 8 1.79 8 4-3.582 4-8 4z"/><path d="M12 12v10"/></svg>
                                    % de Gordura
                                </h3>
                                <p class="text-3xl font-bold text-primary" id="fat-percentage">-</p>
                                <p class="font-medium text-gray-600">Gallagher et al.</p>
                            </div>

                            <div class="result-card border-l-4 border-green-400">
                                <h3 class="font-semibold text-gray-800 flex items-center mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 icon-placeholder"><path d="M15 12c0-2.5-1.5-5-5-5s-5 2.5-5 5c0 2.22 1.21 4.16 3 5.19V20a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1v-2.81c1.79-.93 3-2.97 3-5.19z"/><path d="M12 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/><path d="M20 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/><path d="M20 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/><path d="M20 22a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>
                                    VET
                                </h3>
                                <p class="text-3xl font-bold text-primary" id="vet-value">-</p>
                                <p class="font-medium text-gray-600" id="vet-goal-text">Manter Peso</p>
                            </div>

                            <div class="result-card border-l-4 border-blue-400 md:col-span-2">
                                <h3 class="font-semibold text-gray-800 flex items-center mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 icon-placeholder"><path d="M21.25 4.75a2.25 2.25 0 0 0-4.5 0v14.5a2.25 2.25 0 0 0 4.5 0"/><path d="M16.75 4.75a2.25 2.25 0 0 0-4.5 0v14.5a2.25 2.25 0 0 0 4.5 0"/><path d="M12.25 4.75a2.25 2.25 0 0 0-4.5 0v14.5a2.25 2.25 0 0 0 4.5 0"/><path d="M7.75 4.75a2.25 2.25 0 0 0-4.5 0v14.5a2.25 2.25 0 0 0 4.5 0"/></svg>
                                    Antropometria Adicional
                                </h3>
                                <div class="space-y-2 mt-3 text-gray-700">
                                    <p>Adequação Circ. Braço: <strong class="text-primary" id="acb-perc">-</strong></p>
                                    <p>Adequação DCT: <strong class="text-primary" id="dct-perc">-</strong></p>
                                    <p>Adequação CMB: <strong class="text-primary" id="cmb-perc">-</strong></p>
                                    <p>Área Muscular Braço Corrigida: <strong class="text-primary" id="ambc-value">-</strong></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resumo Visual -->
                        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-1 flex flex-col justify-center items-center">
                                <div id="figure-container" class="relative w-full h-96 flex items-center justify-center">
                                    <img id="figure-image" src="https://placehold.co/300x400/e0e0e0/555?text=?" alt="Visualização Corporal">
                                </div>
                                <p class="text-center font-semibold text-gray-700 mt-2" id="figure-caption">Visualização Corporal</p>
                            </div>
                            <div class="md:col-span-2 result-card border-l-4 border-purple-400">
                                <h3 class="font-semibold text-gray-800 flex items-center mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 icon-placeholder"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    Avaliação Laboratorial
                                </h3>
                                <div class="space-y-3 mt-4">
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="lab-name" list="lab-suggestions" placeholder="Exame (ex: Glicose)" class="flex-grow p-2 border rounded-md">
                                        <datalist id="lab-suggestions">
                                            <option value="Glicose">
                                            <option value="Colesterol Total">
                                            <option value="Triglicerídeos">
                                            <option value="HDL">
                                            <option value="LDL">
                                        </datalist>
                                        <input type="number" id="lab-value" placeholder="Valor" class="w-24 p-2 border rounded-md">
                                        <button type="button" id="add-lab-btn" class="bg-secondary text-white px-3 py-2 rounded-md hover:bg-opacity-90">+</button>
                                    </div>
                                    <div id="lab-results" class="space-y-2 text-gray-700 text-sm">
                                        <!-- Resultados do lab aqui -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seção de Plano Alimentar -->
                    <div id="diet-plan-section" class="bg-white p-6 rounded-xl shadow-lg mt-8">
                        <h2 class="text-2xl font-semibold text-secondary mb-6 border-b pb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M15.5 8.5 12 12l-3.5 3.5"/><path d="m8.5 8.5 7 7"/></svg>
                            Plano Alimentar
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label for="desjejum" class="font-semibold text-gray-700">Desjejum</label>
                                <textarea id="desjejum" rows="3" class="w-full p-2 border rounded-md"></textarea>
                            </div>
                            <div class="space-y-2">
                                <label for="colacao" class="font-semibold text-gray-700">Colação</label>
                                <textarea id="colacao" rows="3" class="w-full p-2 border rounded-md"></textarea>
                            </div>
                            <div class="space-y-2">
                                <label for="almoco" class="font-semibold text-gray-700">Almoço</label>
                                <textarea id="almoco" rows="3" class="w-full p-2 border rounded-md"></textarea>
                            </div>
                            <div class="space-y-2">
                                <label for="lanche" class="font-semibold text-gray-700">Lanche</label>
                                <textarea id="lanche" rows="3" class="w-full p-2 border rounded-md"></textarea>
                            </div>
                            <div class="space-y-2">
                                <label for="jantar" class="font-semibold text-gray-700">Jantar</label>
                                <textarea id="jantar" rows="3" class="w-full p-2 border rounded-md"></textarea>
                            </div>
                            <div class="space-y-2">
                                <label for="ceia" class="font-semibold text-gray-700">Ceia</label>
                                <textarea id="ceia" rows="3" class="w-full p-2 border rounded-md"></textarea>
                            </div>
                        </div>
                        <div class="mt-6 space-y-2">
                            <label for="observacoes" class="font-semibold text-gray-700">Observações / Restrições</label>
                            <textarea id="observacoes" rows="4" class="w-full p-2 border rounded-md"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4 no-print">
                    <button id="print-btn" class="flex items-center justify-center gap-2 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                        Imprimir
                    </button>
                    <button id="whatsapp-btn" class="flex items-center justify-center gap-2 bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                        Gerar PDF para WhatsApp
                    </button>
                    <button id="export-jpeg-btn" class="flex items-center justify-center gap-2 bg-blue-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        Exportar JPEG
                    </button>
                </div>
            </div>
        </div>

        <!-- Rodapé -->
        <footer class="text-center mt-12 py-4 border-t">
            <p class="text-gray-500 text-sm">Desenvolvido por Marcos R Teixeira</p>
        </footer>
    </div>
    
    <!-- Elemento de Notificação -->
    <div id="notification"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elementos do DOM ---
            const form = document.getElementById('patient-form');
            const calculateBtn = document.getElementById('calculate-btn');
            const savePatientBtn = document.getElementById('save-patient-btn');
            const loadPatientBtn = document.getElementById('load-patient-btn');
            const deletePatientBtn = document.getElementById('delete-patient-btn');
            const newPatientBtn = document.getElementById('new-patient-btn');
            const patientListSelect = document.getElementById('patient-list');
            const resultsContainer = document.getElementById('results-container');
            const notification = document.getElementById('notification');
            const percentileCard = document.getElementById('percentile-card');
            
            // --- Imagens Realistas (usando placeholders) ---
            const images = {
                masculino: {
                    magreza: 'https://placehold.co/300x400/e0e0e0/555?text=Magreza',
                    normal: 'https://placehold.co/300x400/e0e0e0/555?text=Normal',
                    sobrepeso: 'https://placehold.co/300x400/e0e0e0/555?text=Sobrepeso',
                    obesidade: 'https://placehold.co/300x400/e0e0e0/555?text=Obesidade'
                },
                feminino: {
                    magreza: 'https://placehold.co/300x400/f0e8e8/555?text=Magreza',
                    normal: 'https://placehold.co/300x400/f0e8e8/555?text=Normal',
                    sobrepeso: 'https://placehold.co/300x400/f0e8e8/555?text=Sobrepeso',
                    obesidade: 'https://placehold.co/300x400/f0e8e8/555?text=Obesidade'
                }
            };

            // --- Dados de Percentil IMC OMS (Amostra para 5 a 19 anos) ---
            // Fonte: WHO BMI-for-age tables. Estes são dados simplificados. Uma implementação completa teria dados para cada mês.
            const percentileData = {
                // Dados para Meninos (5-19 anos)
                boys: [
                    { age: 5, p3: 13.4, p15: 14.2, p50: 15.3, p85: 16.9, p97: 18.6 },
                    { age: 10, p3: 14.4, p15: 15.4, p50: 17.0, p85: 19.6, p97: 22.5 },
                    { age: 15, p3: 16.5, p15: 17.9, p50: 20.0, p85: 23.4, p97: 26.8 },
                    { age: 19, p3: 18.4, p15: 19.9, p50: 22.4, p85: 26.5, p97: 30.5 }
                ],
                // Dados para Meninas (5-19 anos)
                girls: [
                    { age: 5, p3: 13.2, p15: 14.0, p50: 15.2, p85: 17.0, p97: 19.0 },
                    { age: 10, p3: 14.2, p15: 15.3, p50: 17.2, p85: 20.3, p97: 24.0 },
                    { age: 15, p3: 16.3, p15: 17.8, p50: 20.2, p85: 24.0, p97: 28.2 },
                    { age: 19, p3: 17.6, p15: 19.1, p50: 21.8, p85: 26.3, p97: 31.2 }
                ]
            };
            
            // --- Referências Laboratoriais ---
            const labReferences = {
                'glicose': { min: 70, max: 99, unit: 'mg/dL' },
                'colesterol total': { min: 0, max: 190, unit: 'mg/dL' },
                'triglicerídeos': { min: 0, max: 150, unit: 'mg/dL' },
                'hdl': { min: 40, max: Infinity, unit: 'mg/dL' },
                'ldl': { min: 0, max: 130, unit: 'mg/dL' }
            };

            // --- Funções Auxiliares ---
            const getVal = (id) => {
                const el = document.getElementById(id);
                return el ? (el.type === 'number' ? parseFloat(el.value) || 0 : el.value) : null;
            };

            const setVal = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.value = value;
            }

            const setHtml = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = value;
            };
            
            const showNotification = (message, isSuccess = true) => {
                notification.textContent = message;
                notification.className = isSuccess ? 'bg-green-500' : 'bg-red-500';
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            };
            
            // --- Função para Calcular Percentil ---
            const getBmiPercentile = (ageYears, bmi, gender) => {
                const data = gender === 'masculino' ? percentileData.boys : percentileData.girls;
                // Encontra a faixa etária mais próxima (simplificado)
                const ageData = data.reduce((prev, curr) => 
                    (Math.abs(curr.age - ageYears) < Math.abs(prev.age - ageYears) ? curr : prev)
                );

                if (bmi < ageData.p3) return { value: "< 3", class: "Baixo Peso" };
                if (bmi < ageData.p15) return { value: "3-15", class: "Baixo Peso" };
                if (bmi < ageData.p85) return { value: "15-85", class: "Peso Normal" };
                if (bmi < ageData.p97) return { value: "85-97", class: "Sobrepeso" };
                return { value: "> 97", class: "Obesidade" };
            };


            // --- Lógica Principal de Cálculo ---
            const calculateAll = () => {
                const nome = getVal('nome');
                const sexo = getVal('sexo');
                const idade = getVal('idade');
                const peso = getVal('peso');
                const altura = getVal('altura');
                const circAbdominal = getVal('circunferencia_abdominal');
                const dct = getVal('dct');
                const perimetroBraco = getVal('perimetro_braco');
                const vetGoal = getVal('vet-goal');
                
                if (!peso || !altura || !idade) {
                    showNotification('Preencha Idade, Peso e Altura para calcular.', false);
                    return;
                }

                // Cálculos
                const imc = peso / (altura * altura);
                let imcClass = '', imcKey = 'normal';
                
                // Lógica de Percentil para 0-19 anos
                if (idade >= 0 && idade <= 19) {
                    percentileCard.classList.remove('hidden');
                    const percentile = getBmiPercentile(idade, imc, sexo);
                    setHtml('percentile-value', `P${percentile.value}`);
                    setHtml('percentile-class', percentile.class);
                    
                    // Ajusta a classificação geral e a imagem baseada no percentil
                    imcClass = percentile.class;
                    if (percentile.class === "Baixo Peso") imcKey = 'magreza';
                    else if (percentile.class === "Peso Normal") imcKey = 'normal';
                    else if (percentile.class === "Sobrepeso") imcKey = 'sobrepeso';
                    else if (percentile.class === "Obesidade") imcKey = 'obesidade';
                    
                } else {
                    percentileCard.classList.add('hidden');
                    // Lógica de IMC para adultos (>19 anos)
                    if (imc < 18.5) { imcClass = 'Magreza'; imcKey = 'magreza'; }
                    else if (imc <= 24.9) { imcClass = 'Peso normal'; imcKey = 'normal'; }
                    else if (imc <= 29.9) { imcClass = 'Sobrepeso'; imcKey = 'sobrepeso'; }
                    else { imcClass = 'Obesidade'; imcKey = 'obesidade'; }
                }
                
                const idealWeight = 21.7 * (altura * altura);

                let rcqClass = 'Risco normal';
                if (sexo === 'masculino' && circAbdominal >= 94) rcqClass = 'Risco aumentado';
                if (sexo === 'feminino' && circAbdominal >= 80) rcqClass = 'Risco aumentado';
                
                const sexValue = sexo === 'masculino' ? 1 : 0;
                const fatPercentage = 64.5 - (848 / imc) + (0.079 * idade) - (16.4 * sexValue) + (0.05 * sexValue * idade) + (39.0 * sexValue / imc);

                let vetRange = [0, 0], vetGoalText = '';
                if (vetGoal === 'manter') { vetRange = [25 * peso, 35 * peso]; vetGoalText = 'Manter Peso'; }
                else if (vetGoal === 'perder') { vetRange = [20 * peso, 25 * peso]; vetGoalText = 'Perder Peso'; }
                else if (vetGoal === 'ganhar') { vetRange = [30 * peso, 35 * peso]; vetGoalText = 'Ganhar Peso'; }

                const p50_cb = sexo === 'masculino' ? 29.3 : 28.5;
                const p50_dct = sexo === 'masculino' ? 12.5 : 16.5;
                const p50_cmb = sexo === 'masculino' ? 25.3 : 23.2;
                const acbPerc = (perimetroBraco / p50_cb) * 100;
                const dctPerc = (dct / p50_dct) * 100;
                const cmb = perimetroBraco - (Math.PI * (dct / 10));
                const cmbPerc = (cmb / p50_cmb) * 100;
                const amb = Math.pow(cmb, 2) / (4 * Math.PI);
                const correctionFactor = sexo === 'masculino' ? 10 : 6.5;
                const ambc = amb - correctionFactor;

                // --- Atualizar UI ---
                setHtml('report-name', `Paciente: ${nome || 'Não informado'}`);
                setHtml('imc-value', imc.toFixed(2));
                setHtml('imc-class', imcClass);
                setHtml('ideal-weight', `${idealWeight.toFixed(2)} kg`);
                setHtml('rcq-value', `${circAbdominal.toFixed(1)} cm`);
                setHtml('rcq-class', rcqClass);
                setHtml('fat-percentage', `${fatPercentage.toFixed(1)}%`);
                setHtml('vet-value', `${vetRange[0].toFixed(0)} - ${vetRange[1].toFixed(0)} kcal`);
                setHtml('vet-goal-text', vetGoalText);
                setHtml('acb-perc', `${acbPerc.toFixed(1)}%`);
                setHtml('dct-perc', `${dctPerc.toFixed(1)}%`);
                setHtml('cmb-perc', `${cmbPerc.toFixed(1)}%`);
                setHtml('ambc-value', `${ambc.toFixed(2)} cm²`);

                // Atualizar Imagem Realista
                document.getElementById('figure-image').src = images[sexo][imcKey];
                setHtml('figure-caption', `Visualização: ${imcClass}`);

                resultsContainer.classList.remove('hidden');
            };

            // --- Gerenciamento de Pacientes (localStorage) ---
            const getPatients = () => JSON.parse(localStorage.getItem('nutriplus_patients_v3')) || [];
            
            const populatePatientList = () => {
                const patients = getPatients();
                patientListSelect.innerHTML = '<option value="">Selecione um paciente</option>';
                patients.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.nome;
                    patientListSelect.appendChild(option);
                });
            };

            const clearForm = () => {
                form.reset();
                setVal('patient-id', '');
                ['desjejum', 'colacao', 'almoco', 'lanche', 'jantar', 'ceia', 'observacoes'].forEach(id => setVal(id, ''));
                resultsContainer.classList.add('hidden');
                document.getElementById('lab-results').innerHTML = '';
            };

            savePatientBtn.addEventListener('click', () => {
                const nome = getVal('nome');
                if (!nome) {
                    showNotification('O nome do paciente é obrigatório para salvar.', false);
                    return;
                }
                let patients = getPatients();
                const patientId = getVal('patient-id') || Date.now().toString();
                
                const patientData = { id: patientId, nome, sexo: getVal('sexo'), idade: getVal('idade'), peso: getVal('peso'), altura: getVal('altura'), circunferencia_abdominal: getVal('circunferencia_abdominal'), dct: getVal('dct'), dcb: getVal('dcb'), perimetro_braco: getVal('perimetro_braco'), 'vet-goal': getVal('vet-goal'), desjejum: getVal('desjejum'), colacao: getVal('colacao'), almoco: getVal('almoco'), lanche: getVal('lanche'), jantar: getVal('jantar'), ceia: getVal('ceia'), observacoes: getVal('observacoes') };

                const existingIndex = patients.findIndex(p => p.id === patientId);
                if (existingIndex > -1) {
                    patients[existingIndex] = patientData;
                } else {
                    patients.push(patientData);
                }
                
                localStorage.setItem('nutriplus_patients_v3', JSON.stringify(patients));
                populatePatientList();
                patientListSelect.value = patientId;
                showNotification('Paciente salvo com sucesso!');
            });

            loadPatientBtn.addEventListener('click', () => {
                const patientId = getVal('patient-list');
                if (!patientId) {
                    showNotification('Selecione um paciente para carregar.', false);
                    return;
                }
                const patient = getPatients().find(p => p.id === patientId);
                if (patient) {
                    Object.keys(patient).forEach(key => setVal(key, patient[key]));
                    setVal('patient-id', patient.id);
                    calculateAll();
                }
            });

            deletePatientBtn.addEventListener('click', () => {
                const patientId = getVal('patient-list');
                if (!patientId) {
                    showNotification('Selecione um paciente para deletar.', false);
                    return;
                }
                let patients = getPatients().filter(p => p.id !== patientId);
                localStorage.setItem('nutriplus_patients_v3', JSON.stringify(patients));
                populatePatientList();
                clearForm();
                showNotification('Paciente deletado.', true);
            });
            
            newPatientBtn.addEventListener('click', clearForm);

            // --- Lógica de Avaliação Laboratorial ---
            document.getElementById('add-lab-btn').addEventListener('click', () => {
                const labName = getVal('lab-name').toLowerCase();
                const labValue = getVal('lab-value');
                if (!labName || !labValue) return;

                const ref = labReferences[labName];
                let status = 'Normal', color = 'text-green-600', refText = '';

                if (ref) {
                    if (labValue < ref.min) { status = 'Abaixo'; color = 'text-blue-600'; }
                    if (labValue > ref.max) { status = 'Acima'; color = 'text-red-600'; }
                    refText = `(Ref: ${ref.min === 0 ? '<' : ref.min}${ref.max === Infinity ? '+' : ' - ' + ref.max} ${ref.unit})`;
                }

                const resultEl = document.createElement('p');
                resultEl.innerHTML = `${getVal('lab-name')}: <strong>${labValue}</strong> - <span class="${color} font-semibold">${status}</span> <span class="text-gray-500">${refText}</span>`;
                document.getElementById('lab-results').appendChild(resultEl);
                setVal('lab-name', '');
                setVal('lab-value', '');
            });

            // --- Botões de Ação ---
            const generatePdf = () => {
                const { jsPDF } = window.jspdf;
                const reportElement = document.getElementById('printable-area');
                const nomePaciente = getVal('nome') || 'paciente';
                
                showNotification('Gerando PDF, por favor aguarde...', true);

                html2canvas(reportElement, { scale: 2, useCORS: true, windowWidth: 1200 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`relatorio-nutriplus-${nomePaciente}.pdf`);
                });
            };

            document.getElementById('print-btn').addEventListener('click', () => window.print());
            document.getElementById('whatsapp-btn').addEventListener('click', () => {
                generatePdf();
                const text = encodeURIComponent("Olá! Segue o relatório nutricional em PDF que acabei de gerar na Calculadora NUTRI+.");
                setTimeout(() => { window.open(`https://wa.me/?text=${text}`, '_blank'); }, 1000);
            });
            document.getElementById('export-jpeg-btn').addEventListener('click', () => {
                const reportElement = document.getElementById('printable-area');
                html2canvas(reportElement, { scale: 2, useCORS: true, windowWidth: 1200 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `relatorio-nutriplus-${getVal('nome') || 'paciente'}.jpeg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                });
            });

            // --- Inicialização ---
            calculateBtn.addEventListener('click', calculateAll);
            populatePatientList();
        });
    </script>
</body>
</html>
